<!DOCTYPE html>
<html>
 
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css?family=M+PLUS+1p" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css?family=Hachi+Maru+Pop" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Yusei+Magic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Reggae+One" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Sawarabi+Gothic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">

    <link href="./font.css" rel="stylesheet">

    <link rel="icon" href="./img/favicon2/favicon.ico" />
    <script src="js/bouyomichan_client.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKQVD3TMXH"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FKQVD3TMXH');
    </script>
    <!-- END: Google tag (gtag.js) -->


    <title>jimakuChanï¼šéŸ³å£°èªè­˜å­—å¹•ã¡ã‚ƒã‚“</title>

    <style type="text/css">
        button, input, select, textarea {
            /* font-family : inherit; */
            /* font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo,sans-serif; */
            /* font-size   : 300%; */
            /* color  : black; */
            font-weight : 0;
            /*text-align  : center;       /* left, center, right */
            vertical-align : top;    /* top, middle, bottom */
            -webkit-text-stroke-color: rgb(21, 0, 141);
            -webkit-text-stroke-width: 0px;
        }

        html {
            height: 100%;
            width: 100%;
        }

        body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow:hidden;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            /* font-family:'07NikumaruFont'; */
        }
        table {
            width: 100%;
            overflow:hidden;
            /* table-layout: fixed; */
        }
        table.btm_table {
            position:absolute;
            /* bottom:0; */
        }

        table td {
            /*word-break: break-all;*/
            overflow-wrap : break-word;
        }
    </style>

    <style>
        /* prepare the selectors to add a stroke to */

        .stroke-single-imb{
            /* position: absolute; */
            left: 0;
            right: 0;
            margin: 0;
            margin-left: 5px;
            /* -webkit-text-stroke: 0px #0000FF;  */
        }

        .stroke-single-bg{
            position: absolute;
            left: 0;
            right: 0;
            margin: auto;
            margin-left: 5px;
            /* -webkit-text-stroke: 3px #FF0000;  */
        }
        /* add a single stroke */
        .stroke-single-fg{
            position: absolute;
            left: 0;
            right: 0;
            margin: auto;
            margin-left: 5px;
            /* -webkit-text-stroke: 0px #FFFFFF; */
        }

    </style>

    <script>

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ç”¨é–¢æ•° ---------------------------
        function getParam(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&]*)|&|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // ä¸€å®šæ™‚é–“å¤‰åŒ–ãŒãªã‹ã£ãŸã‚‰æ¶ˆã™ ------------------------------------
        var fn_del = function() {
            document.getElementById('speech_text-imb').innerHTML = '';
            document.getElementById('speech_text-bg').innerHTML = '';
            document.getElementById('speech_text-fg').innerHTML = '';
            document.getElementById('trans_text-imb').innerHTML = '';
            document.getElementById('trans_text-bg').innerHTML = '';
            document.getElementById('trans_text-fg').innerHTML = '';
            document.getElementById('trans_text2-imb').innerHTML = '';
            document.getElementById('trans_text2-bg').innerHTML = '';
            document.getElementById('trans_text2-fg').innerHTML = '';
            document.getElementById('trans_text3-imb').innerHTML = '';
            document.getElementById('trans_text3-bg').innerHTML = '';
            document.getElementById('trans_text3-fg').innerHTML = '';

            // å„ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            isSpeechRecognitionComplete = false;
            isTextTranslation1Complete = false;
            isTextTranslation2Complete = false;
            isTextTranslation3Complete = false;
            
            // ä¿æŒãƒ†ã‚­ã‚¹ãƒˆã‚‚ã‚¯ãƒªã‚¢
            currentInterimText = '';
            lastFinalText = '';
        };


        // URLã‹ã‚‰ã®å€¤èª­ã¿è¾¼ã¿(å‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼) -------------------
        var timer = getParam('timer');
        
        // ä¸€å®šæ™‚é–“èªè­˜çµæœãŒãªã‹ã£ãŸã‚‰ï¼Œãã“ã§èªè­˜çµ‚äº† --------------------
        var short_pause = getParam('short_pause');
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’ç¢ºèª
        console.log('ã‚¿ã‚¤ãƒãƒ¼è¨­å®š:', {
            timer: timer + 'ms (ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤)',
            short_pause: short_pause + 'ms (éŸ³å£°ãƒãƒ¼ã‚ºæ¤œå‡º)'
        });

        //////////////////////////////////////////////////////////
        // URLã‹ã‚‰ã®å€¤èª­ã¿è¾¼ã¿ -------------------
        var arg_showAudioLevel = getParam('showAudioLevel');
        var arg_enhanceAccuracy = getParam('enhanceAccuracy');
        var arg_noiseReduction = getParam('noiseReduction');
        var arg_volumeNormalization = getParam('volumeNormalization');
        var arg_showConfidence = getParam('showConfidence');
        var arg_useCustomDictionary = getParam('useCustomDictionary');
        var arg_customDictionary = getParam('customDictionary');
        var arg_recog = getParam('recog');
        console.log('éŸ³å£°èªè­˜è¨€èªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', arg_recog);
        var arg_trans = getParam('trans');
        var arg_trans2 = getParam('trans2');
        var arg_trans3 = getParam('trans3');

        /////////////////////////////////////////////////////////
        // ç¿»è¨³APIç”¨è¨­å®š ---------------------------
        if (arg_trans != null) var request = new XMLHttpRequest();
        if (arg_trans2 != null) var request2 = new XMLHttpRequest();
        if (arg_trans3 != null) var request3 = new XMLHttpRequest();

        // ç¿»è¨³ç”¨è¨­å®š ---------------------------
        var trans_sourcelang = 'ja';
        var trans_destlang = 'en';
        var trans2_destlang = '';
        var trans3_destlang = '';


        var gas_key = getParam('gas_key');
        
        var TRANS_URL = 'https://script.google.com/macros/s/' + gas_key + '/exec';
        var query = ''

        // ãã®ä»–ã®è¨­å®š -----------------------
        var bouyomi = getParam('bouyomi');
        var anti_sexual = getParam('anti_sexual');
        
        // ã‚«ã‚¹ã‚¿ãƒ è¾æ›¸ã®æº–å‚™
        var customDictionary = {};
        if (arg_useCustomDictionary === 'true' && arg_customDictionary) {
            try {
                const dictionaryText = decodeURIComponent(arg_customDictionary);
                const entries = dictionaryText.split('ã€').concat(dictionaryText.split(','));
                entries.forEach(entry => {
                    const parts = entry.split('=');
                    if (parts.length === 2) {
                        customDictionary[parts[0].trim()] = parts[1].trim();
                    }
                });
                console.log('ã‚«ã‚¹ã‚¿ãƒ è¾æ›¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(customDictionary).length + 'ä»¶');
            } catch (error) {
                console.error('ã‚«ã‚¹ã‚¿ãƒ è¾æ›¸ã®è§£æã«å¤±æ•—:', error);
            }
        }
        
        // ç¿»è¨³å‰å‡¦ç†é–¢æ•°ï¼ˆã‚«ã‚¹ã‚¿ãƒ è¾æ›¸é©ç”¨ï¼‰
        function applyCustomDictionary(text) {
            if (arg_useCustomDictionary !== 'true' || Object.keys(customDictionary).length === 0) {
                return text;
            }
            
            let processedText = text;
            for (const [key, value] of Object.entries(customDictionary)) {
                const regex = new RegExp('\\b' + key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                processedText = processedText.replace(regex, value);
            }
            return processedText;
        }

        // ä¸é©åˆ‡èªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–¢æ•°ï¼ˆéŸ³å£°èªè­˜ç”¨ï¼‰
        function applyContentFilter(text) {
            if (anti_sexual === 'false' || badWords_forRecog.length === 0) {
                return text;
            }
            
            let filteredText = text;
            
            // ä¿è­·ã™ã‚‹å˜èªã‚’ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«ç½®ãæ›ãˆã‚‹
            goodWords_forRecog.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{GOOD_WORD_${index}}}`;
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, placeholder);
                }
            });

            // ä¸é©åˆ‡èªã‚’***ã«ç½®ãæ›ãˆã‚‹
            badWords_forRecog.forEach(word => {
                if (word && word.trim() !== '') {
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, "*".repeat(word.length));
                }
            });

            // ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä¿è­·ã™ã‚‹å˜èªã«æˆ»ã™
            goodWords_forRecog.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{GOOD_WORD_${index}}}`;
                    const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "g");
                    filteredText = filteredText.replace(regex, word);
                }
            });

            return filteredText;
        }

        // ç¿»è¨³çµæœç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–¢æ•°
        function applyTranslationFilter(text, transType) {
            if (anti_sexual === 'false' || !text || text.trim() === '') {
                return text;
            }
            
            let badWordsList, goodWordsList;
            
            // ç¿»è¨³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªä¸é©åˆ‡èªãƒªã‚¹ãƒˆã‚’é¸æŠ
            switch(transType) {
                case 1:
                    badWordsList = badWords_forTrans1;
                    goodWordsList = goodWords_forTrans1;
                    break;
                case 2:
                    badWordsList = badWords_forTrans2;
                    goodWordsList = goodWords_forTrans2;
                    break;
                case 3:
                    badWordsList = badWords_forTrans3;
                    goodWordsList = goodWords_forTrans3;
                    break;
                default:
                    return text;
            }
            
            if (badWordsList.length === 0) {
                console.log('ç¿»è¨³' + transType + 'ç”¨ã®ä¸é©åˆ‡èªãƒªã‚¹ãƒˆãŒç©ºã®ãŸã‚ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return text;
            }
            
            let filteredText = text;
            
            // ä¿è­·ã™ã‚‹å˜èªã‚’ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«ç½®ãæ›ãˆã‚‹
            goodWordsList.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{TRANS${transType}_GOOD_WORD_${index}}}`;
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, placeholder);
                }
            });

            // ä¸é©åˆ‡èªã‚’***ã«ç½®ãæ›ãˆã‚‹
            badWordsList.forEach(word => {
                if (word && word.trim() !== '') {
                    const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
                    filteredText = filteredText.replace(regex, "*".repeat(word.length));
                }
            });

            // ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä¿è­·ã™ã‚‹å˜èªã«æˆ»ã™
            goodWordsList.forEach((word, index) => {
                if (word && word.trim() !== '') {
                    let placeholder = `{{TRANS${transType}_GOOD_WORD_${index}}}`;
                    const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "g");
                    filteredText = filteredText.replace(regex, word);
                }
            });

            console.log('ç¿»è¨³' + transType + 'ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: "' + text + '" -> "' + filteredText + '"');
            return filteredText;
        }


        // ä¸€å®šæ™‚é–“èªè­˜çµæœãŒãªã‹ã£ãŸã‚‰ï¼Œãã“ã§èªè­˜çµ‚äº† --------------------
        // short_pauseã¯ä¸Šéƒ¨ã§æ—¢ã«å®šç¾©æ¸ˆã¿

        var stop_recog;
        var id_stop_recog;

        var count = 0;

        // URLã‹ã‚‰ Bad/Good å˜èªãƒªã‚¹ãƒˆã‚’ãƒªã‚¹ãƒˆå½¢å¼ã§èª­ã¿è¾¼ã‚€ -----------------------
        // ãƒã‚¤ãƒ•ãƒ³ä»˜ãè¨€èªã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ç”¨ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        function getFilterLanguageId(langCode) {
            const languageMapping = {
                'zh-CN': 'zh',     // ä¸­å›½èªï¼ˆç°¡ä½“å­—ï¼‰
                'zh-TW': 'zh',     // å°æ¹¾èªï¼ˆç¹ä½“å­—ï¼‰ â†’ ä¸­å›½èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨
                'zh-HK': 'zh',     // é¦™æ¸¯èªï¼ˆç¹ä½“å­—ï¼‰ â†’ ä¸­å›½èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨
                'en-US': 'en',     // ã‚¢ãƒ¡ãƒªã‚«è‹±èª â†’ è‹±èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨
                'fr-FR': 'fr',     // ãƒ•ãƒ©ãƒ³ã‚¹èª
                'it-IT': 'it',     // ã‚¤ã‚¿ãƒªã‚¢èª
                'de-DE': 'de',     // ãƒ‰ã‚¤ãƒ„èª
                'tr-TR': 'tr',     // ãƒˆãƒ«ã‚³èª
                'sv-SE': 'sv',     // ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³èª
                'pl-PL': 'pl',     // ãƒãƒ¼ãƒ©ãƒ³ãƒ‰èª
                'uk-UA': 'uk',     // ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèª
                'ru-RU': 'ru',     // ãƒ­ã‚·ã‚¢èª
                'es-ES': 'es',     // ã‚¹ãƒšã‚¤ãƒ³èª
                'pt-PT': 'pt',     // ãƒãƒ«ãƒˆã‚¬ãƒ«èª
                'th-TH': 'th',     // ã‚¿ã‚¤èª
                'el-GR': 'el'      // ã‚®ãƒªã‚·ãƒ£èª
            };
            
            return languageMapping[langCode] || langCode;
        }
        
        // ç¿»è¨³APIç”¨ã®è¨€èªã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
        function getTranslationLanguageId(langCode) {
            const languageMapping = {
                'zh-CN': 'zh-CN',  // ä¸­å›½èªï¼ˆç°¡ä½“å­—ï¼‰
                'zh-TW': 'zh-TW',  // å°æ¹¾èªï¼ˆç¹ä½“å­—ï¼‰
                'zh-HK': 'zh-HK',  // é¦™æ¸¯èªï¼ˆç¹ä½“å­—ï¼‰
                'en-US': 'en',     // ã‚¢ãƒ¡ãƒªã‚«è‹±èª
                'fr-FR': 'fr',     // ãƒ•ãƒ©ãƒ³ã‚¹èª
                'it-IT': 'it',     // ã‚¤ã‚¿ãƒªã‚¢èª
                'de-DE': 'de',     // ãƒ‰ã‚¤ãƒ„èª
                'tr-TR': 'tr',     // ãƒˆãƒ«ã‚³èª
                'sv-SE': 'sv',     // ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³èª
                'pl-PL': 'pl',     // ãƒãƒ¼ãƒ©ãƒ³ãƒ‰èª
                'uk-UA': 'uk',     // ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠèª
                'ru-RU': 'ru',     // ãƒ­ã‚·ã‚¢èª
                'es-ES': 'es',     // ã‚¹ãƒšã‚¤ãƒ³èª
                'pt-PT': 'pt',     // ãƒãƒ«ãƒˆã‚¬ãƒ«èª
                'nl-NL': 'nl',     // ã‚ªãƒ©ãƒ³ãƒ€èª
                'id-ID': 'id',     // ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª
                'vi-VN': 'vi',     // ãƒ™ãƒˆãƒŠãƒ èª
                'th-TH': 'th',     // ã‚¿ã‚¤èª
                'ar-SA': 'ar',     // ã‚¢ãƒ©ãƒ“ã‚¢èª
                'el-GR': 'el',     // ã‚®ãƒªã‚·ãƒ£èª
                'ja': 'ja',        // æ—¥æœ¬èª
                'ko': 'ko'         // éŸ“å›½èª
            };
            
            return languageMapping[langCode] || langCode;
        }
        
        let languageId = getFilterLanguageId(arg_recog);
        const baseURL = "https://raw.githubusercontent.com/sayonari/goodBadWordlist/main/";
        const badListPath = `/BadList.txt`; // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã®ãƒ‘ã‚¹
        const goodListPath = `/GoodList.txt`; // è¨±å¯ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã®ãƒ‘ã‚¹
        var badWords_forRecog = [];
        var goodWords_forRecog = [];
        
        // ç¿»è¨³çµæœç”¨ã®ä¸é©åˆ‡èªãƒªã‚¹ãƒˆ
        var badWords_forTrans1 = [];
        var goodWords_forTrans1 = [];
        var badWords_forTrans2 = [];
        var goodWords_forTrans2 = [];
        var badWords_forTrans3 = [];
        var goodWords_forTrans3 = [];

        console.log("original lang code: " + arg_recog + " -> filter lang: " + languageId);
        console.log("url: " + baseURL + languageId + badListPath);
        if (anti_sexual !== 'false') {
            // ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            fetch(baseURL + languageId + badListPath)
                .then( r => r.text() )
                .then( t => {
                    badWords_forRecog = t.split("\n").filter(Boolean);
                    console.log("loaded Bad Words num: " + badWords_forRecog.length);
                });

            // è¨±å¯ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            fetch(baseURL + languageId + goodListPath)
                .then( r => r.text() )
                .then( t => {
                    goodWords_forRecog = t.split("\n").filter(Boolean);
                });
                
            // ç¿»è¨³è¨€èª1ã®ä¸é©åˆ‡èªãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            if(arg_trans != null) {
                const trans1LangId = getFilterLanguageId(arg_trans);
                console.log("trans1 lang: " + arg_trans + " -> filter lang: " + trans1LangId);
                fetch(baseURL + trans1LangId + badListPath)
                    .then( r => r.text() )
                    .then( t => {
                        badWords_forTrans1 = t.split("\n").filter(Boolean);
                        console.log("loaded Trans1 Bad Words num: " + badWords_forTrans1.length);
                    })
                    .catch(e => console.log("Trans1 Bad Words list not found for: " + trans1LangId));
                    
                fetch(baseURL + trans1LangId + goodListPath)
                    .then( r => r.text() )
                    .then( t => {
                        goodWords_forTrans1 = t.split("\n").filter(Boolean);
                    })
                    .catch(e => console.log("Trans1 Good Words list not found for: " + trans1LangId));
            }
            
            // ç¿»è¨³è¨€èª2ã®ä¸é©åˆ‡èªãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            if(arg_trans2 != null) {
                const trans2LangId = getFilterLanguageId(arg_trans2);
                console.log("trans2 lang: " + arg_trans2 + " -> filter lang: " + trans2LangId);
                fetch(baseURL + trans2LangId + badListPath)
                    .then( r => r.text() )
                    .then( t => {
                        badWords_forTrans2 = t.split("\n").filter(Boolean);
                        console.log("loaded Trans2 Bad Words num: " + badWords_forTrans2.length);
                    })
                    .catch(e => console.log("Trans2 Bad Words list not found for: " + trans2LangId));
                    
                fetch(baseURL + trans2LangId + goodListPath)
                    .then( r => r.text() )
                    .then( t => {
                        goodWords_forTrans2 = t.split("\n").filter(Boolean);
                    })
                    .catch(e => console.log("Trans2 Good Words list not found for: " + trans2LangId));
            }
            
            // ç¿»è¨³è¨€èª3ã®ä¸é©åˆ‡èªãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
            if(arg_trans3 != null) {
                const trans3LangId = getFilterLanguageId(arg_trans3);
                console.log("trans3 lang: " + arg_trans3 + " -> filter lang: " + trans3LangId);
                fetch(baseURL + trans3LangId + badListPath)
                    .then( r => r.text() )
                    .then( t => {
                        badWords_forTrans3 = t.split("\n").filter(Boolean);
                        console.log("loaded Trans3 Bad Words num: " + badWords_forTrans3.length);
                    })
                    .catch(e => console.log("Trans3 Bad Words list not found for: " + trans3LangId));
                    
                fetch(baseURL + trans3LangId + goodListPath)
                    .then( r => r.text() )
                    .then( t => {
                        goodWords_forTrans3 = t.split("\n").filter(Boolean);
                    })
                    .catch(e => console.log("Trans3 Good Words list not found for: " + trans3LangId));
            }
        }


        // éŸ³å£°èªè­˜æœ¬ä½“ /////////////////////////////////////////////////
        window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;

        // Web Speech APIã¯ãƒ‡ãƒã‚¤ã‚¹é¸æŠã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ãŸã‚ã€ã“ã®å‡¦ç†ã¯ç„¡åŠ¹
        function initializeAudioDevice() {
            console.log('Web Speech APIã¯æ—¢å®šã®éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹ã®ã¿ä½¿ç”¨ã—ã¾ã™');
            return Promise.resolve();
        }

        // éŸ³å£°èªè­˜ç”¨è¨­å®š ----------------------
        var recognition = new webkitSpeechRecognition();
        recognition.lang = 'ja';
        recognition.interimResults = true;
        // recognition.continuous = true;
        var recog_text = '';
        var recog_IM_text = '';
        var recog_conf = 0;
        var trans_text = '';
        var trans2_text = '';
        var trans3_text = '';

        var my_count = count;
        count = count + 1;

        // ãã®ä»–è¨­å®š ----------------------------
        var isSpeechRecognitionComplete = false;
        var isTextTranslation1Complete = false;
        var isTextTranslation2Complete = false;
        var isTextTranslation3Complete = false;
        var currentInterimText = '';  // ç¾åœ¨ã®é€”ä¸­çµæœã‚’ä¿æŒ
        var lastFinalText = '';       // æœ€å¾Œã®ç¢ºå®šçµæœã‚’ä¿æŒ

        // åˆ†é›¢ã•ã‚ŒãŸã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ----------------------------
        var speechDeleteTimerId = null;  // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã®ID
        var translationDeleteTimerId = null;  // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã®ID
        var isSpeechTextCleared = false;  // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆãŒå‰Šé™¤æ¸ˆã¿ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        
        // ç‹¬ç«‹ã—ãŸãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç®¡ç†
        var speechProgressUpdateIntervalId = null;  // éŸ³å£°èªè­˜ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ID
        var speechTimerStartTime = null;  // éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚åˆ»
        var speechTimerDuration = null;   // éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼ç¶™ç¶šæ™‚é–“
        
        var translationProgressUpdateIntervalId = null;  // ç¿»è¨³ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ID
        var translationTimerStartTime = null;  // ç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚åˆ»
        var translationTimerDuration = null;   // ç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼ç¶™ç¶šæ™‚é–“

        // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã§ç½®ãæ›ãˆã‚‹é–¢æ•°
        function clearSpeechText() {
            document.getElementById('speech_text-imb').innerHTML = 'ã€€'; // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹
            document.getElementById('speech_text-bg').innerHTML = 'ã€€';
            document.getElementById('speech_text-fg').innerHTML = 'ã€€';
            isSpeechTextCleared = true;  // å‰Šé™¤æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            console.log('éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ç½®æ›ï¼‰');
        }

        // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã§ç½®ãæ›ãˆã‚‹é–¢æ•°
        function clearTranslationText() {
            if(arg_trans != null) {
                document.getElementById('trans_text-imb').innerHTML = 'ã€€';
                document.getElementById('trans_text-bg').innerHTML = 'ã€€';
                document.getElementById('trans_text-fg').innerHTML = 'ã€€';
            }
            if(arg_trans2 != null) {
                document.getElementById('trans_text2-imb').innerHTML = 'ã€€';
                document.getElementById('trans_text2-bg').innerHTML = 'ã€€';
                document.getElementById('trans_text2-fg').innerHTML = 'ã€€';
            }
            if(arg_trans3 != null) {
                document.getElementById('trans_text3-imb').innerHTML = 'ã€€';
                document.getElementById('trans_text3-bg').innerHTML = 'ã€€';
                document.getElementById('trans_text3-fg').innerHTML = 'ã€€';
            }
            console.log('ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ç½®æ›ï¼‰');
        }

        // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetSpeechTimer() {
            if (speechDeleteTimerId !== null) {
                console.log('ğŸ”„ éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ (ID:' + speechDeleteTimerId + ')');
                clearTimeout(speechDeleteTimerId);
                speechDeleteTimerId = null;
            } else {
                console.log('âšª éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆè¦æ±‚ï¼ˆã‚¿ã‚¤ãƒãƒ¼ãªã—ï¼‰');
            }
            // éŸ³å£°èªè­˜ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã¿ãƒªã‚»ãƒƒãƒˆ
            if (speechProgressUpdateIntervalId !== null) {
                clearInterval(speechProgressUpdateIntervalId);
                speechProgressUpdateIntervalId = null;
            }
            updateTimerProgressBar(0, 'ğŸ¤å¾…æ©Ÿ', 'linear-gradient(90deg, #FF6B6B 0%, #FFA07A 50%, #FFE4E1 100%)', 'speech');
        }

        // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetTranslationTimer() {
            if (translationDeleteTimerId !== null) {
                console.log('ğŸ”„ ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ (ID:' + translationDeleteTimerId + ')');
                clearTimeout(translationDeleteTimerId);
                translationDeleteTimerId = null;
            }
            // ç¿»è¨³ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã¿ãƒªã‚»ãƒƒãƒˆ
            if (translationProgressUpdateIntervalId !== null) {
                clearInterval(translationProgressUpdateIntervalId);
                translationProgressUpdateIntervalId = null;
            }
            updateTimerProgressBar(0, 'ğŸŒå¾…æ©Ÿ', 'linear-gradient(90deg, #2196F3 0%, #64B5F6 50%, #BBDEFB 100%)', 'translation');
        }

        // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startSpeechDeleteTimer() {
            resetSpeechTimer(); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            
            if (timer != null && timer !== '') {
                var duration = parseInt(timer);
                
                if (isNaN(duration) || duration <= 0) {
                    console.log('âŒ éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹å¤±æ•—: ç„¡åŠ¹ãªæ™‚é–“è¨­å®š:', timer);
                    return;
                }
                
                speechDeleteTimerId = setTimeout(function() {
                    console.log('â° éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼æº€äº† - ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ (ID:' + speechDeleteTimerId + ')');
                    clearSpeechText();
                    speechDeleteTimerId = null;
                    updateTimerProgressBar(0, 'ğŸ¤å®Œäº†', '#4CAF50', 'speech');
                    setTimeout(function() {
                        updateTimerProgressBar(0, 'ğŸ¤å¾…æ©Ÿ', 'linear-gradient(90deg, #FF6B6B 0%, #FFA07A 50%, #FFE4E1 100%)', 'speech');
                    }, 1000);
                }, duration);
                
                console.log('ğŸ¤â±ï¸ éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹:', duration + 'ms', '(ID:' + speechDeleteTimerId + ')');
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
                startProgressBarCountdown(duration, 'speech');
            } else {
                console.log('âŒ éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹å¤±æ•—: timerè¨­å®šãªã— (timer=' + timer + ')');
            }
        }

        // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startTranslationDeleteTimer() {
            resetTranslationTimer(); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            
            if (timer != null && timer !== '') {
                var duration = parseInt(timer);
                
                translationDeleteTimerId = setTimeout(function() {
                    console.log('ç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼æº€äº† - ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢');
                    clearTranslationText();
                    translationDeleteTimerId = null;
                }, duration);
                
                console.log('ğŸŒâ±ï¸ ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹:', timer + 'ms');
                
                // ç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼ã®å ´åˆã¯ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’é’è‰²ã§è¡¨ç¤º
                startProgressBarCountdown(duration, 'translation');
            }
        }

        // ç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
        function updateTranslationStatus(status, color) {
            try {
                if (window.parent && window.parent.document) {
                    var statusElement = window.parent.document.getElementById('translationStatus');
                    if (statusElement) {
                        statusElement.innerHTML = status;
                        statusElement.style.color = color || '#666';
                    }
                }
            } catch (error) {
                console.log('ç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°é–¢æ•°ï¼ˆå€‹åˆ¥ãƒãƒ¼å¯¾å¿œï¼‰
        function updateTimerProgressBar(percent, text, color, type) {
            try {
                if (window.parent && window.parent.document) {
                    var barId = type === 'translation' ? 'transTimerProgressBar' : 'speechTimerProgressBar';
                    var textId = type === 'translation' ? 'transTimerProgressText' : 'speechTimerProgressText';
                    
                    var progressBar = window.parent.document.getElementById(barId);
                    var progressText = window.parent.document.getElementById(textId);
                    
                    if (progressBar && progressText) {
                        progressBar.style.width = percent + '%';
                        progressText.innerHTML = text;
                        
                        if (color) {
                            progressBar.style.background = color;
                        }
                    }
                }
            } catch (error) {
                console.log('ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆç‹¬ç«‹ç‰ˆï¼‰
        function startProgressBarCountdown(duration, type) {
            var intervalId;
            var startTime;
            var timerDuration;
            
            if (type === 'translation') {
                // ç¿»è¨³ç”¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ—¢å­˜æ›´æ–°ã‚’åœæ­¢
                if (translationProgressUpdateIntervalId !== null) {
                    clearInterval(translationProgressUpdateIntervalId);
                    translationProgressUpdateIntervalId = null;
                }
                translationTimerStartTime = Date.now();
                translationTimerDuration = duration;
                startTime = translationTimerStartTime;
                timerDuration = translationTimerDuration;
            } else {
                // éŸ³å£°èªè­˜ç”¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ—¢å­˜æ›´æ–°ã‚’åœæ­¢
                if (speechProgressUpdateIntervalId !== null) {
                    clearInterval(speechProgressUpdateIntervalId);
                    speechProgressUpdateIntervalId = null;
                }
                speechTimerStartTime = Date.now();
                speechTimerDuration = duration;
                startTime = speechTimerStartTime;
                timerDuration = speechTimerDuration;
            }

            // ã‚¿ã‚¤ãƒãƒ¼ç¨®é¡ã«å¿œã˜ã¦è‰²ã‚’æ±ºå®š
            var colorGradient;
            var typeText = '';
            if (type === 'translation') {
                colorGradient = 'linear-gradient(90deg, #2196F3 0%, #64B5F6 50%, #BBDEFB 100%)';
                typeText = 'ğŸŒ';
            } else {
                colorGradient = 'linear-gradient(90deg, #FF6B6B 0%, #FFA07A 50%, #FFE4E1 100%)';
                typeText = 'ğŸ¤';
            }

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼åˆæœŸåŒ–
            var initialSeconds = Math.round(duration / 1000);
            updateTimerProgressBar(100, typeText + ' ' + initialSeconds + 's', colorGradient, type);

            // 50msæ¯ã«ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°ï¼ˆã‚ˆã‚Šæ»‘ã‚‰ã‹ï¼‰
            intervalId = setInterval(function() {
                var elapsed = Date.now() - startTime;
                var remaining = Math.max(0, timerDuration - elapsed);
                var percent = (remaining / timerDuration) * 100;
                var remainingSeconds = Math.ceil(remaining / 1000);

                if (remaining > 0) {
                    // æ®‹ã‚Šæ™‚é–“ã«å¿œã˜ã¦è‰²ã‚’å¤‰åŒ–
                    var urgencyLevel = remaining / timerDuration;
                    var displayColor;
                    if (urgencyLevel > 0.5) {
                        displayColor = colorGradient;
                    } else if (urgencyLevel > 0.2) {
                        displayColor = 'linear-gradient(90deg, #FFA726 0%, #FFB74D 50%, #FFE0B2 100%)';
                    } else {
                        displayColor = 'linear-gradient(90deg, #F44336 0%, #EF5350 50%, #FFCDD2 100%)';
                    }
                    
                    updateTimerProgressBar(percent, typeText + ' ' + remainingSeconds + 's', displayColor, type);
                } else {
                    updateTimerProgressBar(0, typeText + ' å‰Šé™¤!', '#D32F2F', type);
                    clearInterval(intervalId);
                    
                    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«IDã‚’ã‚¯ãƒªã‚¢
                    if (type === 'translation') {
                        translationProgressUpdateIntervalId = null;
                    } else {
                        speechProgressUpdateIntervalId = null;
                    }
                }
            }, 50);
            
            // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«IDã‚’ä¿å­˜
            if (type === 'translation') {
                translationProgressUpdateIntervalId = intervalId;
            } else {
                speechProgressUpdateIntervalId = intervalId;
            }
        }



        function shouldClearText() {
            // Check if each process is enabled and if it's complete
            var recogComplete = isSpeechRecognitionComplete;
            var trans1Complete = arg_trans != null ? isTextTranslation1Complete : true;
            var trans2Complete = arg_trans2 != null ? isTextTranslation2Complete : true;
            var trans3Complete = arg_trans3 != null ? isTextTranslation3Complete : true;

            return recogComplete && trans1Complete && trans2Complete && trans3Complete;
        }


        stop_recog = function() {
            console.log("stop by short pause!");
            recognition.stop();
            // ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ¼ã‚ºã§åœæ­¢ã—ãŸå ´åˆã¯ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã—ãªã„ï¼ˆonspeechend/onsoundendã§é–‹å§‹æ¸ˆã¿ï¼‰
        };

        ///////////////////////////////////////////////////////////
        // å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã¸ã®å¯¾å¿œ --------------------------------- 
        // éŸ³å£°ãƒ»èªè­˜ é–‹å§‹
        recognition.onstart = () => {
            console.log("onstart cnt:" + String(my_count));
            // éŸ³å£°èªè­˜é–‹å§‹æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆå®Ÿéš›ã®éŸ³å£°æ¤œå‡ºæ™‚ã«ãƒªã‚»ãƒƒãƒˆï¼‰
        }
        recognition.onaudiostart = () => {
            console.log("onaudiostart cnt:" + String(my_count));
        }
        recognition.onsoundstart = () => {
            console.log("ğŸ”Š onsoundstart cnt:" + String(my_count));
            // éŸ³å£°æ¤œå‡ºé–‹å§‹æ™‚ã«éŸ³å£°ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            resetSpeechTimer();
        }
        recognition.onspeechstart = () => {
            console.log("ğŸ—£ï¸ onspeechstart cnt:" + String(my_count));
            // ç™ºè©±é–‹å§‹æ™‚ã«éŸ³å£°ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            resetSpeechTimer();
        }
        
        // éŸ³å£°ãƒ»èªè­˜ çµ‚äº†
        recognition.onspeechend = () => {
            console.log("ğŸ”‡ onspeechend cnt:" + String(my_count));
            // ç™ºè©±çµ‚äº†æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã—ãªã„ï¼ˆæœ€çµ‚çµæœå–å¾—æ™‚ã«é–‹å§‹ï¼‰
        }
        recognition.onsoundend = () => {
            console.log("ğŸ”• onsoundend cnt:" + String(my_count));
            // éŸ³å£°æ¤œå‡ºçµ‚äº†æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã—ãªã„ï¼ˆæœ€çµ‚çµæœå–å¾—æ™‚ã«é–‹å§‹ï¼‰
        }
        recognition.onaudioend = () => {
            console.log("onaudioend cnt:" + String(my_count));
        }
        recognition.onend = () => {
            console.log("onend cnt:" + String(my_count));
            
            // éŸ³å£°èªè­˜çµ‚äº†æ™‚ã¯ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã—ãªã„ï¼ˆonspeechend/onsoundendã§æ—¢ã«é–‹å§‹æ¸ˆã¿ï¼‰
            
            // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            isSpeechRecognitionComplete = false;
            isTextTranslation1Complete = false;
            isTextTranslation2Complete = false;
            isTextTranslation3Complete = false;
            
            // å†èµ·å‹•
            setTimeout(() => {
                if (recognition) {
                    recognition.start();
                    my_count = count;
                    count = count + 1;
                }
            }, 100);
        }

        // ã‚¨ãƒ©ãƒ¼ç­‰
        recognition.onerror = (event) => {
            console.log("onerror cnt:" + String(my_count) + " error:" + event.error);
            
            // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†ã‘ã‚‹
            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                console.log('ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™');
                return; // å†èµ·å‹•ã—ãªã„
            }
            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯å†èµ·å‹•
            setTimeout(() => {
                if (recognition) recognition.start();
            }, 1000);
        }
        recognition.onnomatch = () => {
            console.log("onnomatch cnt:" + String(my_count));
            // nomatchã®å ´åˆã¯åœæ­¢ã›ãšç¶™ç¶š
        }


        // è¨€èªè¨­å®š ----------------------------
        if (arg_recog != null) {
            recognition.lang = arg_recog;
            trans_sourcelang = recognition.lang;
            console.log('éŸ³å£°èªè­˜è¨€èªè¨­å®šå®Œäº†:', recognition.lang, 'trans_sourcelang:', trans_sourcelang);
        }
        if (arg_trans != null) {
            trans_destlang = arg_trans;
        }
        if (arg_trans2 != null) {
            trans2_destlang = arg_trans2;
        }
        if (arg_trans3 != null) {
            trans3_destlang = arg_trans3;
        }

        // èªè­˜çµæœãŒè¿”ã£ã¦ããŸã¨ã ------------------
        recognition.onresult = function(event) {
            var results = event.results;
            
            // æœ€æ–°ã®çµæœã‚’æ§‹ç¯‰ï¼ˆç¢ºå®šçµæœ + é€”ä¸­çµæœï¼‰
            var finalText = '';
            var interimText = '';
            var latestConfidence = 0;
            
            for (var i = 0; i < results.length; i++) {
                var transcript = results[i][0].transcript;
                var confidence = results[i][0].confidence || 0;
                
                if (results[i].isFinal) {
                    finalText += transcript;
                    if (confidence > 0) {
                        latestConfidence = confidence;
                    }
                } else {
                    interimText += transcript;
                }
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨
            var filteredFinalText = applyContentFilter(finalText);
            var filteredInterimText = applyContentFilter(interimText);
            
            // è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ç¢ºå®šéƒ¨åˆ† + ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿é€”ä¸­éƒ¨åˆ†ï¼‰
            var displayText = filteredFinalText + filteredInterimText;
            var recog_text = displayText;  // å¾Œç¶šå‡¦ç†ã¨ã®äº’æ›æ€§ã®ãŸã‚


                // æœ€æ–°ã®çµæœã«æœ€çµ‚çµæœãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                var hasNewFinal = false;
                for (var j = event.resultIndex; j < results.length; j++) {
                    if (results[j].isFinal) {
                        hasNewFinal = true;
                        break;
                    }
                }
                
                // #################################################################
                // èªè­˜æœ€çµ‚çµæœãŒæ¥ãŸã‚‰ ###############################################
                if (hasNewFinal)
                {
                    // æœ€çµ‚çµæœå–å¾—æ™‚ã«éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼ˆç™ºè©±çµ‚äº†ã¨ã¿ãªã™ï¼‰
                    console.log('ğŸ¤âš™ï¸ æœ€çµ‚çµæœå–å¾— - éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ (ãƒ†ã‚­ã‚¹ãƒˆ:"' + finalText + '")');
                    
                    // æœ€çµ‚çµæœãŒç©ºã§ãªã„å ´åˆã®ã¿ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                    if (finalText && finalText.trim() !== '') {
                        startSpeechDeleteTimer();
                        isSpeechTextCleared = false;  // æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸã®ã§ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    } else {
                        console.log('âš ï¸ æœ€çµ‚çµæœãŒç©ºã®ãŸã‚ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                    }
                    // èªè­˜çµæœã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ï¼‰ ---------------------
                    var displayTextWithConfidence = filteredFinalText;
                    if (arg_showConfidence === 'true' && latestConfidence > 0) {
                        displayTextWithConfidence += ` (ä¿¡é ¼åº¦: ${Math.round(latestConfidence * 100)}%)`;
                    }
                    document.getElementById('speech_text-imb').innerHTML = displayTextWithConfidence;
                    document.getElementById('speech_text-bg').innerHTML = displayTextWithConfidence;
                    document.getElementById('speech_text-fg').innerHTML = displayTextWithConfidence;
                    isSpeechRecognitionComplete = true; // ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
                    
                    // ç¿»è¨³å‡¦ç†ç”¨ã«æœ€çµ‚ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ï¼‰
                    recog_text = filteredFinalText;
                    lastFinalText = filteredFinalText;  // è¡¨ç¤ºç”¨ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿


                    // æ£’èª­ã¿ã¡ã‚ƒã‚“ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ï¼‰
                    if(bouyomi == "true") {
                        let bouyomiChanClient = new BouyomiChanClient();
                        bouyomiChanClient.talk(recog_text);
                    }

                    if(gas_key != null){
                        
                        // ç¿»è¨³é–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        var activeTranslations = [];
                        if(arg_trans != null) activeTranslations.push('1');
                        if(arg_trans2 != null) activeTranslations.push('2');
                        if(arg_trans3 != null) activeTranslations.push('3');
                        if(activeTranslations.length > 0) {
                            updateTranslationStatus('ç¿»è¨³ä¸­(' + activeTranslations.join(',') + ')', '#0066cc');
                        }

                        // ç¿»è¨³1è¨€èªç›®
                        if(arg_trans != null){
                            const processedText = applyCustomDictionary(recog_text);
                            const sourceLang = getTranslationLanguageId(trans_sourcelang);
                            query = TRANS_URL + '?text=' + encodeURIComponent(processedText) + '&source=' + sourceLang + '&target=' + trans_destlang;
                            request.open('GET', query, true);

                            request.onreadystatechange = function(){
                                if (request.readyState === 4 && request.status === 200){

                                    var responseText1 = request.responseText;

                                    // JSONå½¢å¼ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã€JSONã§ã‚ã‚Œã°translatedTextã‚’æŠ½å‡º
                                    try {
                                        var jsonResponse = JSON.parse(responseText1);
                                        if (jsonResponse.translatedText) {
                                            responseText1 = jsonResponse.translatedText;
                                            var translatedCount = jsonResponse.translatedCount;
                                            document.getElementById('translationCount').innerHTML = translatedCount;
                                            console.log('translatedCount(1):'+translatedCount);
                                        }
                                    } catch (e) {
                                        // JSONå½¢å¼ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                                    }

                                    // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆãŒå‰Šé™¤æ¸ˆã¿ã§ãªã„å ´åˆã®ã¿å†è¡¨ç¤º
                                    if (!isSpeechTextCleared) {
                                        document.getElementById('speech_text-imb').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-bg').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-fg').innerHTML = lastFinalText;
                                    }
                                    
                                    // ç¿»è¨³çµæœ1ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨
                                    var filteredResponseText1 = applyTranslationFilter(responseText1, 1);
                                    document.getElementById('trans_text-imb').innerHTML =  filteredResponseText1;
                                    document.getElementById('trans_text-bg').innerHTML =  filteredResponseText1;
                                    document.getElementById('trans_text-fg').innerHTML =  filteredResponseText1;
                                    isTextTranslation1Complete = true; // ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
                                    
                                    // ç¿»è¨³1å®Œäº†æ™‚ã«ç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                                    startTranslationDeleteTimer();
                                    
                                    // ç¿»è¨³å®Œäº†ãƒã‚§ãƒƒã‚¯
                                    var completedTranslations = 0;
                                    var totalTranslations = 0;
                                    if(arg_trans != null) { totalTranslations++; if(isTextTranslation1Complete) completedTranslations++; }
                                    if(arg_trans2 != null) { totalTranslations++; if(isTextTranslation2Complete) completedTranslations++; }
                                    if(arg_trans3 != null) { totalTranslations++; if(isTextTranslation3Complete) completedTranslations++; }
                                    
                                    if(completedTranslations === totalTranslations) {
                                        updateTranslationStatus('ç¿»è¨³å®Œäº†', '#00aa00');
                                    }
                                } else if (request.readyState === 4) {
                                    // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                                    if (request.status === 429) {
                                        updateTranslationStatus('APIä¸Šé™ã‚¨ãƒ©ãƒ¼', '#cc0000');
                                    } else if (request.status === 403) {
                                        updateTranslationStatus('APIèªè¨¼ã‚¨ãƒ©ãƒ¼', '#cc0000');
                                    } else {
                                        updateTranslationStatus('ç¿»è¨³ã‚¨ãƒ©ãƒ¼(HTTP:' + request.status + ')', '#cc0000');
                                    }
                                }
                            }
                            request.send(null);
                        }

                        // ç¿»è¨³2è¨€èªç›®
                        if(arg_trans2 != null){
                            const processedText2 = applyCustomDictionary(recog_text);
                            const sourceLang2 = getTranslationLanguageId(trans_sourcelang);
                            query2 = TRANS_URL + '?text=' + encodeURIComponent(processedText2) + '&source=' + sourceLang2 + '&target=' + trans2_destlang;
                            request2.open('GET', query2, true);

                            request2.onreadystatechange = function(){
                                if (request2.readyState === 4 && request2.status === 200){

                                    var responseText2 = request2.responseText;

                                    // JSONå½¢å¼ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã€JSONã§ã‚ã‚Œã°translatedTextã‚’æŠ½å‡º
                                    try {
                                        var jsonResponse = JSON.parse(responseText2);
                                        if (jsonResponse.translatedText) {
                                            responseText2 = jsonResponse.translatedText;
                                            document.getElementById('translationCount').innerHTML = jsonResponse.translatedCount;
                                            var translatedCount2 = jsonResponse.translatedCount;
                                            document.getElementById('translationCount').innerHTML = translatedCount2;
                                            console.log('translatedCount(2):'+translatedCount2);
                                        }
                                    } catch (e) {
                                        // JSONå½¢å¼ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                                    }

                                    // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆãŒå‰Šé™¤æ¸ˆã¿ã§ãªã„å ´åˆã®ã¿å†è¡¨ç¤º
                                    if (!isSpeechTextCleared) {
                                        document.getElementById('speech_text-imb').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-bg').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-fg').innerHTML = lastFinalText;
                                    }
                                    
                                    // ç¿»è¨³çµæœ2ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨
                                    var filteredResponseText2 = applyTranslationFilter(responseText2, 2);
                                    document.getElementById('trans_text2-imb').innerHTML = filteredResponseText2;
                                    document.getElementById('trans_text2-bg').innerHTML = filteredResponseText2;
                                    document.getElementById('trans_text2-fg').innerHTML = filteredResponseText2;
                                    isTextTranslation2Complete = true; // ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
                                    
                                    // ç¿»è¨³2å®Œäº†æ™‚ã«ç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼å†é–‹å§‹
                                    startTranslationDeleteTimer();
                                    
                                    // ç¿»è¨³å®Œäº†ãƒã‚§ãƒƒã‚¯
                                    var completedTranslations = 0;
                                    var totalTranslations = 0;
                                    if(arg_trans != null) { totalTranslations++; if(isTextTranslation1Complete) completedTranslations++; }
                                    if(arg_trans2 != null) { totalTranslations++; if(isTextTranslation2Complete) completedTranslations++; }
                                    if(arg_trans3 != null) { totalTranslations++; if(isTextTranslation3Complete) completedTranslations++; }
                                    
                                    if(completedTranslations === totalTranslations) {
                                        updateTranslationStatus('ç¿»è¨³å®Œäº†', '#00aa00');
                                    }
                                } else if (request2.readyState === 4) {
                                    // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                                    if (request2.status === 429) {
                                        updateTranslationStatus('APIä¸Šé™ã‚¨ãƒ©ãƒ¼', '#cc0000');
                                    } else if (request2.status === 403) {
                                        updateTranslationStatus('APIèªè¨¼ã‚¨ãƒ©ãƒ¼', '#cc0000');
                                    } else {
                                        updateTranslationStatus('ç¿»è¨³ã‚¨ãƒ©ãƒ¼(HTTP:' + request2.status + ')', '#cc0000');
                                    }
                                }
                            }
                            request2.send(null);
                        }

                        // ç¿»è¨³2è¨€èªç›®
                        if(arg_trans3 != null){
                            const processedText3 = applyCustomDictionary(recog_text);
                            const sourceLang3 = getTranslationLanguageId(trans_sourcelang);
                            query3 = TRANS_URL + '?text=' + encodeURIComponent(processedText3) + '&source=' + sourceLang3 + '&target=' + trans3_destlang;
                            request3.open('GET', query3, true);

                            request3.onreadystatechange = function(){
                                if (request3.readyState === 4 && request3.status === 200){

                                    var responseText3 = request3.responseText;

                                    // JSONå½¢å¼ã§ã‚ã‚‹ã‹ã‚’ç¢ºèªã—ã€JSONã§ã‚ã‚Œã°translatedTextã‚’æŠ½å‡º
                                    try {
                                        var jsonResponse = JSON.parse(responseText3);
                                        if (jsonResponse.translatedText) {
                                            responseText3 = jsonResponse.translatedText;
                                            document.getElementById('translationCount').innerHTML = jsonResponse.translatedCount;
                                            var translatedCount3 = jsonResponse.translatedCount;
                                            document.getElementById('translationCount').innerHTML = translatedCount3;
                                            console.log('translatedCount(3):'+translatedCount3);
                                        }
                                    } catch (e) {
                                        // JSONå½¢å¼ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                                    }

                                    // éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆãŒå‰Šé™¤æ¸ˆã¿ã§ãªã„å ´åˆã®ã¿å†è¡¨ç¤º
                                    if (!isSpeechTextCleared) {
                                        document.getElementById('speech_text-imb').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-bg').innerHTML = lastFinalText;
                                        document.getElementById('speech_text-fg').innerHTML = lastFinalText;
                                    }
                                    
                                    // ç¿»è¨³çµæœ3ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨
                                    var filteredResponseText3 = applyTranslationFilter(responseText3, 3);
                                    document.getElementById('trans_text3-imb').innerHTML = filteredResponseText3;
                                    document.getElementById('trans_text3-bg').innerHTML = filteredResponseText3;
                                    document.getElementById('trans_text3-fg').innerHTML = filteredResponseText3;
                                    isTextTranslation3Complete = true; // ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°
                                    
                                    // ç¿»è¨³3å®Œäº†æ™‚ã«ç¿»è¨³ã‚¿ã‚¤ãƒãƒ¼å†é–‹å§‹
                                    startTranslationDeleteTimer();
                                    
                                    // ç¿»è¨³å®Œäº†ãƒã‚§ãƒƒã‚¯
                                    var completedTranslations = 0;
                                    var totalTranslations = 0;
                                    if(arg_trans != null) { totalTranslations++; if(isTextTranslation1Complete) completedTranslations++; }
                                    if(arg_trans2 != null) { totalTranslations++; if(isTextTranslation2Complete) completedTranslations++; }
                                    if(arg_trans3 != null) { totalTranslations++; if(isTextTranslation3Complete) completedTranslations++; }
                                    
                                    if(completedTranslations === totalTranslations) {
                                        updateTranslationStatus('ç¿»è¨³å®Œäº†', '#00aa00');
                                    }
                                } else if (request3.readyState === 4) {
                                    // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                                    if (request3.status === 429) {
                                        updateTranslationStatus('APIä¸Šé™ã‚¨ãƒ©ãƒ¼', '#cc0000');
                                    } else if (request3.status === 403) {
                                        updateTranslationStatus('APIèªè¨¼ã‚¨ãƒ©ãƒ¼', '#cc0000');
                                    } else {
                                        updateTranslationStatus('ç¿»è¨³ã‚¨ãƒ©ãƒ¼(HTTP:' + request3.status + ')', '#cc0000');
                                    }
                                }
                            }
                            request3.send(null);
                        }

                    } else {
                        document.getElementById('speech_text-imb').innerHTML = filteredFinalText;
                        document.getElementById('speech_text-bg').innerHTML = filteredFinalText;
                        document.getElementById('speech_text-fg').innerHTML = filteredFinalText;
                        // API KEYãŒãªã„å ´åˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                        updateTranslationStatus('API KEYãªã—', '#999');
                    }

                }
                // #################################################################
                // èªè­˜é€”ä¸­çµæœãŒæ¥ãŸã‚‰ ###############################################
                else
                {
                    // é€”ä¸­çµæœå–å¾—æ™‚ã«éŸ³å£°èªè­˜ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆï¼ˆéŸ³å£°å…¥åŠ›ä¸­ã®ãŸã‚ï¼‰
                    console.log('ğŸ”„ é€”ä¸­çµæœå–å¾— - ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ (ãƒ†ã‚­ã‚¹ãƒˆ:"' + displayText + '")');
                    resetSpeechTimer();
                    // ã€Œã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ¼ã‚¹ãŒæ¥ãŸã‚‰ï¼ŒéŸ³å£°èªè­˜ã‚’å¼·åˆ¶çš„ã«æ­¢ã‚ã‚‹ã€ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’å‰Šé™¤ã™ã‚‹ -------
                    if(short_pause != null && short_pause !== '') {
                        clearTimeout(id_stop_recog);
                        // ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ¼ã‚ºã‚¹ãƒˆãƒƒãƒ—ç”¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
                        id_stop_recog = setTimeout(stop_recog, parseInt(short_pause));
                        console.log('ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ¼ã‚ºã‚¿ã‚¤ãƒãƒ¼è¨­å®š:', short_pause + 'ms');
                    }

                    // é€”ä¸­çµæœã®è¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ç¢ºå®šéƒ¨åˆ† + ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿é€”ä¸­éƒ¨åˆ†ã‚’æ˜ç¢ºã«åŒºåˆ¥ï¼‰
                    if(displayText !== ""){
                        var displayHtml = '';
                        if (filteredFinalText !== '') {
                            displayHtml += filteredFinalText;
                        }
                        if (filteredInterimText !== '') {
                            displayHtml += ' << ' + filteredInterimText + ' >>';
                        }
                        
                        document.getElementById('speech_text-imb').innerHTML = displayHtml;
                        document.getElementById('speech_text-bg').innerHTML = displayHtml;
                        document.getElementById('speech_text-fg').innerHTML = displayHtml;
                    }
                }
            // å˜ä¸€ãƒ«ãƒ¼ãƒ—ã«çµ±åˆ
        }

        // éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹åˆæœŸåŒ–å¾Œã«éŸ³å£°èªè­˜ã‚’é–‹å§‹
        initializeAudioDevice().then(() => {
            recognition.start();
            console.log("recog start: cnt:" + String(my_count));
            // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
            if (gas_key != null && gas_key !== '') {
                updateTranslationStatus('å¾…æ©Ÿä¸­', '#666');
            } else {
                updateTranslationStatus('API KEYãªã—', '#999');
            }
        }).catch(() => {
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒã‚¤ã‚¹ã§é–‹å§‹
            recognition.start();
            console.log("recog start (default device): cnt:" + String(my_count));
            // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
            if (gas_key != null && gas_key !== '') {
                updateTranslationStatus('å¾…æ©Ÿä¸­', '#666');
            } else {
                updateTranslationStatus('API KEYãªã—', '#999');
            }
        });

    </script> 
</head>
 





<body>
    <div class="big" id="result_text">
        <table id="text_table" class="btm_table" style="overflow:hidden;">
            <tr><td id="tbl_td" align="center" valign='bottom'>
                <div id="speech_text">
                    <div class="stroke-single-bg" id="speech_text-bg"></div> 
                    <div class="stroke-single-fg" id="speech_text-fg"></div>
                    <div class="stroke-single-imb" id="speech_text-imb"></div> 
                </div>

                <div id="trans_text">
                    <div class="stroke-single-bg" id="trans_text-bg"></div>  
                    <div class="stroke-single-fg" id="trans_text-fg"></div>  
                    <div class="stroke-single-imb" id="trans_text-imb"></div>  
                </div>

                <div id="trans_text2">
                    <div class="stroke-single-bg" id="trans_text2-bg"></div>  
                    <div class="stroke-single-fg" id="trans_text2-fg"></div>  
                    <div class="stroke-single-imb" id="trans_text2-imb"></div>  
                </div>

                <div id="trans_text3">
                    <div class="stroke-single-bg" id="trans_text3-bg"></div>  
                    <div class="stroke-single-fg" id="trans_text3-fg"></div>  
                    <div class="stroke-single-imb" id="trans_text3-imb"></div>  
                </div>
            </td></tr>
        </table>
    </div>

    <!-- ç¿»è¨³å›æ•°ç®¡ç† -->
    <div id="translationCount" style="display: none;"></div>

</body>









<!-- ############## æœ«å°¾ã®javascript ############## -->
<script type="text/javascript">

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®è¡¨ç¤º ---------------------------------
const SoftwareTitle = "éŸ³å£°èªè­˜å­—å¹•ã¡ã‚ƒã‚“";
const SoftwareVersion = "2025.7.21 11:21";
const SoftwareDeveloper = "[é–‹ç™ºè€…ï¼šã•ããŸã‚“ ï¼† ã•ã‚ˆãªã‚ŠÏ‰/(å¤§å­¦æ•™å“¡)è¥¿æ‘è‰¯å¤ª]"

// Web Speech APIä½¿ç”¨æ™‚ã®ãƒ‡ãƒã‚¤ã‚¹åˆ¶é™ã«ã¤ã„ã¦
console.log('éŸ³å£°èªè­˜: Web Speech APIã¯æ—¢å®šã®éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹ã®ã¿ä½¿ç”¨');
console.log('ãƒ‡ãƒã‚¤ã‚¹ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯OSã®è¨­å®šã§æ—¢å®šãƒ‡ãƒã‚¤ã‚¹ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');

const speech_text_first = "[" + SoftwareTitle + " (Ver:" + SoftwareVersion + ")" + "]";
document.getElementById('speech_text-bg').innerHTML = speech_text_first;
document.getElementById('speech_text-fg').innerHTML = speech_text_first;
document.getElementById('speech_text-imb').innerHTML = speech_text_first;

const trans1_text_first = SoftwareDeveloper;
document.getElementById('trans_text-bg').innerHTML = trans1_text_first
document.getElementById('trans_text-fg').innerHTML = trans1_text_first
document.getElementById('trans_text-imb').innerHTML = trans1_text_first

const trans2_text_first = "[ã“ã“ã«çµæœè¡¨ç¤ºï¼ˆç¿»è¨³ï¼’ï¼‰]";
document.getElementById('trans_text2-bg').innerHTML = trans2_text_first;
document.getElementById('trans_text2-fg').innerHTML = trans2_text_first;
document.getElementById('trans_text2-imb').innerHTML = trans2_text_first;

const trans3_text_first = "[ã“ã“ã«çµæœè¡¨ç¤ºï¼ˆç¿»è¨³ï¼“ï¼‰]";
document.getElementById('trans_text3-bg').innerHTML = trans3_text_first;
document.getElementById('trans_text3-fg').innerHTML = trans3_text_first;
document.getElementById('trans_text3-imb').innerHTML = trans3_text_first;


// å¯¾è±¡è¨€èªã‚’åˆ©ç”¨ã—ãªã„å ´åˆï¼ŒåˆæœŸè¡¨ç¤ºæ–‡ã®å‰Šé™¤ /////
if (getParam('trans') == null) {
    document.getElementById('trans_text-bg').innerHTML = '';
    document.getElementById('trans_text-fg').innerHTML = '';
    document.getElementById('trans_text-imb').innerHTML = '';
}
if (getParam('trans2') == null) {
    document.getElementById('trans_text2-bg').innerHTML = '';
    document.getElementById('trans_text2-fg').innerHTML = '';
    document.getElementById('trans_text2-imb').innerHTML = '';
}
if (getParam('trans3') == null) {
    document.getElementById('trans_text3-bg').innerHTML = '';
    document.getElementById('trans_text3-fg').innerHTML = '';
    document.getElementById('trans_text3-imb').innerHTML = '';
}

// è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ ---------------------------------
if (getParam('bgcolor') != null){
    document.bgColor = getParam('bgcolor');
}

if (getParam('v_align') == "top"){
    document.getElementById("text_table").style.bottom = -1;
} else if(getParam('v_align') == "bottom"){
    document.getElementById("text_table").style.bottom = 0;
}

if (getParam('textAlign') != null){
    document.getElementById("text_table").style.textAlign = getParam('textAlign');
    document.getElementById("tbl_td").style.textAlign = getParam('textAlign');
    if(getParam('textAlign') == "right"){
        document.getElementById("text_table").style.direction = "rtl";
        document.getElementById("tbl_td").style.direction = "rtl";
        document.body.style.direction = "rtl";
    }
}

if (getParam('whiteSpace') != null){
    document.getElementById("text_table").style.whiteSpace = getParam('whiteSpace');
}

// é«˜ã•åˆã‚ã›ç”¨ãƒ•ã‚©ãƒ³ãƒˆï¼ˆè‰²ã‚’èƒŒæ™¯è‰²ã¨åŒã˜ã«ã™ã‚‹ï¼‰ ############################################
// éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ -------
if (getParam('bgcolor') != null){
    document.getElementById("speech_text-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("speech_text-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width1') != null){
    document.getElementById("speech_text-imb").style.webkitTextStrokeWidth = getParam('st_width1') + 'pt';
}

// ç¿»è¨³çµæœãƒ†ã‚­ã‚¹ãƒˆ -------
if (getParam('bgcolor') != null){
    document.getElementById("trans_text-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("trans_text-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width2') != null){
    document.getElementById("trans_text-imb").style.webkitTextStrokeWidth = getParam('st_width2') + 'pt';
}

// ç¿»è¨³çµæœãƒ†ã‚­ã‚¹ãƒˆï¼ˆç¬¬2è¨€èªï¼‰ -------
if (getParam('bgcolor') != null){
    document.getElementById("trans_text2-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("trans_text2-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width3') != null){
    document.getElementById("trans_text2-imb").style.webkitTextStrokeWidth = getParam('st_width3') + 'pt';
}

// ç¿»è¨³çµæœãƒ†ã‚­ã‚¹ãƒˆï¼ˆç¬¬3è¨€èªï¼‰ -------
if (getParam('bgcolor') != null){
    document.getElementById("trans_text3-imb").style.webkitTextStrokeColor = getParam('bgcolor');
    document.getElementById("trans_text3-imb").style.color = getParam('bgcolor');
}
if (getParam('st_width4') != null){
    document.getElementById("trans_text3-imb").style.webkitTextStrokeWidth = getParam('st_width4') + 'pt';
}



// è¡¨ç¤ºè¨­å®š ############################################
// å…¨ä½“å…±é€š ----------------

// éŸ³å£°èªè­˜çµæœ ----------------
if (getParam('speech_text_font') != null){
    var fontValue = getParam('speech_text_font');
    console.log('[DEBUG] speech_text_font from URL:', fontValue);
    
    // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é™¤å»
    fontValue = fontValue.replace(/\\\\/g, '');
    
    // ãƒ•ã‚©ãƒ³ãƒˆåã‚’æ­£ã—ãè¨­å®šï¼ˆã‚¯ã‚©ãƒ¼ãƒˆã‚’è¿½åŠ ï¼‰
    // Kleeãƒ•ã‚©ãƒ³ãƒˆã®å ´åˆã€æ­£ã—ã„åå‰ã«å¤‰æ›
    if (fontValue.toLowerCase() === 'klee') {
        fontValue = 'Klee';  // macOSã§ã¯å¤§æ–‡å­—ã§å§‹ã¾ã‚‹
    }
    var fontFamily = '"' + fontValue + '", sans-serif';
    document.getElementById("speech_text").style.fontFamily = fontFamily;
    
    // å­è¦ç´ ã«ã‚‚é©ç”¨
    var bgElement = document.getElementById("speech_text-bg");
    var fgElement = document.getElementById("speech_text-fg");
    var imbElement = document.getElementById("speech_text-imb");
    
    if (bgElement) bgElement.style.fontFamily = fontFamily;
    if (fgElement) fgElement.style.fontFamily = fontFamily;
    if (imbElement) imbElement.style.fontFamily = fontFamily;
    
    console.log('[DEBUG] Applied font to speech_text:', document.getElementById("speech_text").style.fontFamily);
    console.log('[DEBUG] Applied font to speech_text-fg:', fgElement ? fgElement.style.fontFamily : 'element not found');
}

if (getParam('size1') != null){
    document.getElementById("speech_text").style.fontSize = getParam('size1') + 'pt';
}

if (getParam('weight1') != null){
    document.getElementById("speech_text").style.fontWeight = getParam('weight1');
}

if (getParam('color1') != null){
    document.getElementById("speech_text-fg").style.color = getParam('color1');
}

if (getParam('st_color1') != null){
    document.getElementById("speech_text-bg").style.webkitTextStrokeColor = getParam('st_color1');
}

if (getParam('st_width1') != null){
    document.getElementById("speech_text-bg").style.webkitTextStrokeWidth = getParam('st_width1') + 'pt';
}

// ç¿»è¨³çµæœãƒ†ã‚­ã‚¹ãƒˆ ----------------
if (getParam('trans_text_font') != null){
    var fontValue = getParam('trans_text_font');
    // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é™¤å»
    fontValue = fontValue.replace(/\\\\/g, '');
    if (fontValue.toLowerCase() === 'klee') {
        fontValue = 'Klee';
    }
    var fontFamily = '"' + fontValue + '", sans-serif';
    document.getElementById("trans_text").style.fontFamily = fontFamily;
    
    // å­è¦ç´ ã«ã‚‚é©ç”¨
    var bgElement = document.getElementById("trans_text-bg");
    var fgElement = document.getElementById("trans_text-fg");
    var imbElement = document.getElementById("trans_text-imb");
    
    if (bgElement) bgElement.style.fontFamily = fontFamily;
    if (fgElement) fgElement.style.fontFamily = fontFamily;
    if (imbElement) imbElement.style.fontFamily = fontFamily;
}

if (getParam('size2') != null){
    document.getElementById("trans_text").style.fontSize = getParam('size2') + 'pt';
}

if (getParam('weight2') != null){
    document.getElementById("trans_text").style.fontWeight = getParam('weight2');
}

if (getParam('color2') != null){
    document.getElementById("trans_text-fg").style.color = getParam('color2');
}

if (getParam('st_color2') != null){
    document.getElementById("trans_text-bg").style.webkitTextStrokeColor = getParam('st_color2');
}

if (getParam('st_width2') != null){
    document.getElementById("trans_text-bg").style.webkitTextStrokeWidth = getParam('st_width2') + 'pt';
}

// ç¿»è¨³çµæœãƒ†ã‚­ã‚¹ãƒˆï¼ˆç¬¬2è¨€èªï¼‰ -----------
if (getParam('trans_text2_font') != null){
    var fontValue = getParam('trans_text2_font');
    // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é™¤å»
    fontValue = fontValue.replace(/\\\\/g, '');
    if (fontValue.toLowerCase() === 'klee') {
        fontValue = 'Klee';
    }
    var fontFamily = '"' + fontValue + '", sans-serif';
    document.getElementById("trans_text2").style.fontFamily = fontFamily;
    
    // å­è¦ç´ ã«ã‚‚é©ç”¨
    var bgElement = document.getElementById("trans_text2-bg");
    var fgElement = document.getElementById("trans_text2-fg");
    var imbElement = document.getElementById("trans_text2-imb");
    
    if (bgElement) bgElement.style.fontFamily = fontFamily;
    if (fgElement) fgElement.style.fontFamily = fontFamily;
    if (imbElement) imbElement.style.fontFamily = fontFamily;
}


if (getParam('size3') != null){
    document.getElementById("trans_text2").style.fontSize = getParam('size3') + 'pt';
}

if (getParam('weight3') != null){
    document.getElementById("trans_text2").style.fontWeight = getParam('weight3');
}

if (getParam('color3') != null){
    document.getElementById("trans_text2-fg").style.color = getParam('color3');
}

if (getParam('st_color3') != null){
    document.getElementById("trans_text2-bg").style.webkitTextStrokeColor = getParam('st_color3');
}

if (getParam('st_width3') != null){
    document.getElementById("trans_text2-bg").style.webkitTextStrokeWidth = getParam('st_width3') + 'pt';
}

// ç¿»è¨³çµæœãƒ†ã‚­ã‚¹ãƒˆï¼ˆç¬¬2è¨€èªï¼‰ -----------
if (getParam('trans_text3_font') != null){
    var fontValue = getParam('trans_text3_font');
    // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’é™¤å»
    fontValue = fontValue.replace(/\\\\/g, '');
    if (fontValue.toLowerCase() === 'klee') {
        fontValue = 'Klee';
    }
    var fontFamily = '"' + fontValue + '", sans-serif';
    document.getElementById("trans_text3").style.fontFamily = fontFamily;
    
    // å­è¦ç´ ã«ã‚‚é©ç”¨
    var bgElement = document.getElementById("trans_text3-bg");
    var fgElement = document.getElementById("trans_text3-fg");
    var imbElement = document.getElementById("trans_text3-imb");
    
    if (bgElement) bgElement.style.fontFamily = fontFamily;
    if (fgElement) fgElement.style.fontFamily = fontFamily;
    if (imbElement) imbElement.style.fontFamily = fontFamily;
}


if (getParam('size4') != null){
    document.getElementById("trans_text3").style.fontSize = getParam('size4') + 'pt';
}

if (getParam('weight4') != null){
    document.getElementById("trans_text3").style.fontWeight = getParam('weight4');
}

if (getParam('color4') != null){
    document.getElementById("trans_text3-fg").style.color = getParam('color4');
}

if (getParam('st_color4') != null){
    document.getElementById("trans_text3-bg").style.webkitTextStrokeColor = getParam('st_color4');
}

if (getParam('st_width4') != null){
    document.getElementById("trans_text3-bg").style.webkitTextStrokeWidth = getParam('st_width4') + 'pt';
}

// è¡Œé–“è¨­å®š ############################################
if (getParam('line_spacing_1') != null){
    // èªè­˜ãƒ†ã‚­ã‚¹ãƒˆã¨ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ1ã®é–“
    document.getElementById("speech_text").style.marginBottom = getParam('line_spacing_1') + 'px';
}

if (getParam('line_spacing_2') != null){
    // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ1ã¨ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ2ã®é–“
    document.getElementById("trans_text").style.marginBottom = getParam('line_spacing_2') + 'px';
}

if (getParam('line_spacing_3') != null){
    // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ2ã¨ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ3ã®é–“
    document.getElementById("trans_text2").style.marginBottom = getParam('line_spacing_3') + 'px';
}

</script>




</html>